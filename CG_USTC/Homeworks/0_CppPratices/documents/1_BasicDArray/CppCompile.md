# C/C++ 编译

## 简介

> 注：亦可通过Google或百度在Internet上找到更多相关资料。


C++ 的代码文件有头文件（\*.h）和代码文件（\*.cpp）之分。两者合起来我们称为单元文件。大多数情况下头文件和代码文件是一一对应的。

C/C++ 编译器只编译 (compile)\*.cpp文件，每个\*.cpp文件都编译成为一个\*.obj (object) 文件（见 \debug 目录），最后由链接器(link)链object文件成为可执行文件 (\*.exe)。

## C++ 宏

宏展开：在代码中出现的宏，会用宏实体代替。宏一般都是用大写字母。
`#define` 定义常量、函数宏
`#undef`  结束常量、函数宏定义

## C++ 预处理器

预处理器处理源代码，在编译器之前运行。C++ 预处理时，只是将“宏定义、头文件”加载到源文件 .cpp 文件。即，`#include` 某个文件，相当于将这个文件的代码全部拷贝过来替换了 `#include` 语句。说白点就是把头文件里内容直接“粘帖”到相应的 `#include` 语句处。

预处理器变量有两种状态:已定义和未定义。`#define` 指示接受一个名字并定义该名字为预处理器变量。`#ifndef` 指示检测指定的预处理器变量是否已定义。

如果未定义，那么跟在其后的所有指示都被处理，直到出现 `#endif`.

## C/C++ 编译头文件

头文件 (\*.h) 的作用：

- 解决了某个文件中变量和函数在另一个源文件中引用；
- 头文件中的函数接口和全局变量起占位符的作用和参数类型与表达式匹配的合法行检测的作用；
- 便于二进制的形式发行类库，因此源码实现的细节受到保护（这一点将在后面的练习中学习到）。

头文件是不被编译的，cpp 中引用头文件实际上是当预编译的时候将头文件中的内容插入到 cpp 文件中。因此变量的定义、函数的定义不要写到头文件中。因为头文件很可能要被多个 cpp 引用。当连接的时候可能会出现重复定义的情况。

有 2 种常见的错误：

- 同一编译单元的头文件重复引用，可能会出现重复定义
- 不同编译单元引用同一头文件，链接时发现重复定义

因此

- 为了防止头文件被重复引用，应当使用 `#ifndef  #define ... #endif` 结构
      但是是不是所有的头文件加上这个，能防止出现重复引用导致重复定义的错误呢？
      答案是否定的。在不同的编译单元引用同一头文件的时候，还是会出现重复定义的错误。
     这种结构只能防止第一种情况下的错误。
- 用 `#include <test.h>` 格式来引用标准库的头文件（编译器将从标准库目录开始搜索）。用 `#include “test.h”` 格式来引用非标准库的头文件（编译器将从用户的工作目录开始搜索）。
- 一些头文件要注意：`<iostream>` 和 `<iostream.h>` 格式是不一样的。前者没有后缀。当使用 `<iostream.h>` 时候，相当于在 C 中调用库函数，使用全局命名空间。当使用 `<iostream>` 的时候，该头文件没有定义全局命名空间，必须使用 `using namespace std` 这样才能正确使用。

## C++ 预编译头

头文件的出现，固然给书写程序带来了很大方便。可是到了 Windows 时代后，慢慢就呈现出一些问题了。几乎所有的 Windows 程序都必须包含 windows.h，而那个文件却硕大无比，将它展开后往所有文件中一粘贴，编译的时候立刻慢得像只蜗牛。

到了 MFC 时代后，情况更为恶劣了。毕竟 C 风格的 Windows 头文件里面包含的还仅仅是函数定义和宏，编译难度不算太大，而 MFC 库里面的头文件可都是类声明啊！更何况，一个最简单的工程，都会生成大量的类，需要用到大量的函数。如果工程稍微复杂一些，编译难度可想而知！

但是，人们惊奇地发现，虽然用到的头文件又多又杂，但是在一个工程中，总有那么一堆头文件，是几乎所有 cpp 都必须包含的。那么，可不可以把这些头文件提取出来，只编译一遍，然后所有其它 cpp 就都能使用呢？没错，这就是预编译头的思想都由来！

实践证明，使用了预编译头技术后，编译速度大大提高了。可以到你的工程目录下的 Debug 或 Release 目录中看一看，里面有一个体积极为硕大的 .pch 文件，那就是传说中的“编译之后的预编译头”。

### 概念

所谓的预编译头就是把一个工程中的那一部分代码,预先编译好放在一个文件里(通常是以 .pch 为扩展名的)，这个文件就称为预 编译头文件这些预先编译好的代码可以是任何的 C/C++ 代码--------甚至是 `inline` 的函数，但是必须是稳定的，在工程开发的过程中不会被经常 改变。如果这些代码被修改，则需要重新编译生成预编译头文件。

### 使用

要使用预编译头，我们必须指定一个头文件，这个头文件包含我们不会经常改变的代码和其他的头文件，然后我们用这个头文件来生成一个预编译头文件（.pch 文件）

想必大家都知道 StdAfx.h 这个文件。很多人都认为这是VC提供的一个“系统级别”的，编译器带的一个头文件。其实不是的，这个文件可以是任何名字的。那么我们如何指定它来生成预编译头文件。我们知道一个头文件是不能编译的。所以我们还需要一个 cpp 文件来生成 .pch 文件。这个文件默认的就是 StdAfx.cpp。在这个文件里只有一句代码就是：`#include “Stdafx.h”`。

## 预编译指令

| 指令       | 说明                                                      |
| ---------- | --------------------------------------------------------- |
| `#`        | 空指令，无任何效果                                        |
| `#include` | 包含一个源代码文件                                        |
| `#define`  | 定义宏                                                    |
| `#undef`   | 取消已定义的宏                                            |
| `#if`      | 如果给定条件为真，则编译下面代码                          |
| `#else`    | 作为其他预处理的剩余选项进行编译                          |
| `#ifdef`   | 如果宏已经定义，则编译下面代码                            |
| `#ifndef`  | 如果宏没有定义，则编译下面代码                            |
| `#elif`    | 如果前面的#if给定条件不为真，当前条件为真，则编译下面代码 |
| `#endif`   | 结束一个 `#if……#else` 条件编译块                          |
| `#line`    | 改变当前的行数和文件名称                                  |
| `#pragma`  | 为编译程序提供非常规的控制流信息                          |
| `#error`   | 停止编译并显示错误信息                                    |

